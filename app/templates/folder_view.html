<!DOCTYPE html>
<html lang="en">

<head>
    <title>File Browser - EnderDrive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/darkly/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body style="background: linear-gradient(135deg, #1a1c2c 0%, #2d3748 100%); min-height: 100vh;">
    <!-- Navbar -->
    <nav class="navbar" style="background: #2d3748; padding: 1rem 2rem; width: 100%;">
        <div class="d-flex align-items-center">
            <span class="navbar-text mr-3 text-light">Welcome, {{ username }}</span>
            {% if is_admin %}
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-info ml-2 landing-btn">
                <i class="fas fa-user-shield"></i> Admin Dashboard
            </a>
            {% endif %}
        </div>
        <div class="d-flex">
            <button class="btn landing-btn ml-2" onclick="openGlobalSearch()">
                <i class="fas fa-search"></i> Search All Files
            </button>
            <button class="btn landing-btn ml-2" data-toggle="modal" data-target="#manageSharesModal">
                <i class="fas fa-share-alt"></i> Manage Shares
            </button>
            <button class="btn landing-btn ml-2" data-toggle="modal" data-target="#uploadModal">
                <i class="fas fa-upload"></i> Upload Files
            </button>
            <button class="btn landing-btn ml-2" data-toggle="modal" data-target="#folderModal">
                <i class="fas fa-folder-plus"></i> New Folder
            </button>
            <a href="{{ url_for('auth.logout') }}" class="btn landing-btn register-btn ml-2">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb" style="background: #1a202c; border-radius: 10px;">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('file_manager.browse', path='') }}" class="text-light">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                {% for crumb in breadcrumbs %}
                <li class="breadcrumb-item">
                    <a href="{{ url_for('file_manager.browse', path=crumb.path) }}" class="text-light">{{ crumb.name }}</a>
                </li>
                {% endfor %}
            </ol>
        </nav>

        <div class="landing-box" style="padding: 2rem; margin-top: 1rem;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0 text-light">Files and Folders</h4>
                <div class="search-container" style="width: 400px;">
                    <div class="input-group">
                        <input type="text" id="fileSearch" class="form-control"
                            placeholder="Search files and folders..."
                            style="background: #1a202c; border: 2px solid #4a5568; color: white;">
                        <div class="input-group-append">
                            <span class="input-group-text" style="background: #1a202c; border-color: #4a5568;">
                                <i class="fas fa-search text-light"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Operations Toolbar -->
            <div id="bulkOperationsToolbar" class="mb-4" style="display: none; background: #2d3748; padding: 1rem; border-radius: 10px;">
                <div class="d-flex align-items-center">
                    <span class="text-light mr-3"><span id="selectedCount">0</span> items selected</span>
                    <div class="btn-group">
                        <button class="btn landing-btn" onclick="bulkDownload()" title="Download">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn landing-btn" onclick="bulkCopy()" title="Copy">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="btn landing-btn" onclick="bulkMove()" title="Move">
                            <i class="fas fa-cut"></i> Move
                        </button>
                        <button class="btn landing-btn" onclick="bulkShare()" title="Share">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                        <button class="btn landing-btn register-btn" onclick="bulkDelete()" title="Delete">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-dark table-hover" style="background: #1a202c; border-radius: 10px;">
                    <thead class="thead-light">
                        <tr>
                            <th style="width: 40px; text-align: center; vertical-align: middle;">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" id="selectAll" class="custom-control-input">
                                    <label class="custom-control-label" for="selectAll"></label>
                                </div>
                            </th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if current_path %}
                        <tr>
                            <td></td>
                            <td colspan="5">
                                <a href="{{ url_for('file_manager.browse', path=current_path.rsplit('/', 1)[0] if '/' in current_path else '') }}"
                                    class="text-light">
                                    <i class="fas fa-level-up-alt"></i> ..
                                </a>
                            </td>
                        </tr>
                        {% endif %}

                        {% for item in items %}
                        <tr style="border-color: #2d3748;">
                            <td style="text-align: center; vertical-align: middle;">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input item-checkbox" 
                                        id="checkbox-{{ item.id if item.is_file else item.folder_id }}"
                                        data-id="{{ item.id if item.is_file else item.folder_id }}" 
                                        data-path="{{ item.path }}"
                                        data-type="{{ 'file' if item.is_file else 'folder' }}"
                                        {% if not item.path %}disabled{% endif %}>
                                    <label class="custom-control-label" for="checkbox-{{ item.id if item.is_file else item.folder_id }}"></label>
                                </div>
                            </td>
                            <td style="vertical-align: middle;">
                                {% if item.is_file %}
                                <i class="fas fa-file text-primary"></i>
                                <a href="{{ url_for('file_manager.download_file', path=item.path) }}" class="text-light ml-2">
                                    {{ item.name }}
                                </a>
                                {% else %}
                                <i class="fas fa-folder text-warning"></i>
                                <a href="{{ url_for('file_manager.browse', path=item.path) }}" class="text-light ml-2">
                                    {{ item.name }}
                                </a>
                                {% endif %}
                            </td>
                            <td style="vertical-align: middle;">{{ 'File' if item.is_file else 'Folder' }}</td>
                            <td style="vertical-align: middle;">{{ item.size if item.is_file else '-' }}</td>
                            <td style="vertical-align: middle;">{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td style="vertical-align: middle;">
                                <div class="btn-group">
                                    {% if item.is_file %}
                                    <a href="{{ url_for('file_manager.download_file', path=item.path) }}"
                                        class="btn btn-sm landing-btn" title="Download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    {% endif %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm landing-btn dropdown-toggle" type="button" 
                                            data-toggle="dropdown">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right" style="background: #2d3748;">
                                            <button class="dropdown-item text-light" onclick="copyItem('{{ item.id if item.is_file else item.folder_id }}', '{{ item.path }}', {{ 'true' if item.is_file else 'false' }})">
                                                <i class="fas fa-copy mr-2"></i> Copy
                                            </button>
                                            <button class="dropdown-item text-light" onclick="moveItem('{{ item.id if item.is_file else item.folder_id }}', '{{ item.path }}', {{ 'true' if item.is_file else 'false' }})">
                                                <i class="fas fa-cut mr-2"></i> Move
                                            </button>
                                            <button class="dropdown-item text-light" onclick="shareItem('{{ item.id if item.is_file else item.folder_id }}', '{{ item.path }}', {{ 'true' if item.is_file else 'false' }})">
                                                <i class="fas fa-share-alt mr-2"></i> Share
                                            </button>
                                            <div class="dropdown-divider"></div>
                                            <button class="dropdown-item text-danger" onclick="deleteItem('{{ item.path }}', {{ 'true' if item.is_file else 'false' }})">
                                                <i class="fas fa-trash mr-2"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Share Item</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="text-light">Link expires in:</label>
                        <select class="form-control" id="expiresIn" style="background: #1a202c; color: white; border-color: #4a5568;">
                            <option value="1">1 day</option>
                            <option value="7" selected>7 days</option>
                            <option value="30">30 days</option>
                            <option value="365">1 year</option>
                        </select>
                    </div>
                    <div class="form-group mt-3" id="shareLinkContainer" style="display: none;">
                        <label class="text-light">Share Link:</label>
                        <div class="input-group">
                            <input type="text" id="shareLink" class="form-control" readonly
                                style="background: #1a202c; color: white; border-color: #4a5568;">
                            <div class="input-group-append">
                                <button class="btn btn-primary" onclick="copyShareLink()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn register-btn" data-dismiss="modal">Close</button>
                    <button type="button" class="btn landing-btn" onclick="generateShareLink()">Generate Link</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Upload Files</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <form action="{{ url_for('file_manager.upload', path=current_path) }}" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="text-light">Upload Type:</label>
                            <div class="btn-group btn-group-toggle w-100 mb-3" data-toggle="buttons">
                                <label class="btn btn-outline-primary active">
                                    <input type="radio" name="uploadType" value="files" checked> Files
                                </label>
                                <label class="btn btn-outline-primary">
                                    <input type="radio" name="uploadType" value="folder"> Folder
                                </label>
                            </div>
                        </div>
                        <div class="form-group" id="fileUploadSection">
                            <label class="text-light">Select Files:</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="file" name="file" multiple>
                                <label class="custom-file-label" for="file"
                                    style="background: #1a202c; color: white; border-color: #4a5568;">
                                    Choose files
                                </label>
                            </div>
                        </div>
                        <div class="form-group d-none" id="folderUploadSection">
                            <label class="text-light">Select Folder:</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="folder" name="file" webkitdirectory directory multiple>
                                <label class="custom-file-label" for="folder"
                                    style="background: #1a202c; color: white; border-color: #4a5568;">
                                    Choose folder
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="uploadedFileNames" class="p-3 text-light"></div>
                    <script>
                        function updateFileList(input) {
                            const uploadedFileNamesDiv = document.getElementById("uploadedFileNames");
                            let fileList = input.files;

                            if (fileList.length === 0) {
                                uploadedFileNamesDiv.innerHTML = '';
                            } else {
                                let names = [];
                                for (let i = 0; i < Math.min(fileList.length, 5); i++) {
                                    names.push('<li>' + fileList[i].name + '</li>');
                                }
                                if (fileList.length > 5) {
                                    names.push('<li>...and ' + (fileList.length - 5) + ' more files</li>');
                                }
                                uploadedFileNamesDiv.innerHTML = 'Selected: <ul class="mb-0">' + names.join('') + '</ul>';
                            }
                        }

                        document.getElementById('file').addEventListener('change', function() {
                            updateFileList(this);
                            const label = this.nextElementSibling;
                            label.textContent = this.files.length > 1 ? 
                                this.files.length + ' files selected' : 
                                this.files[0].name;
                        });

                        document.getElementById('folder').addEventListener('change', function() {
                            updateFileList(this);
                            const label = this.nextElementSibling;
                            label.textContent = this.files.length > 0 ? 
                                'Folder with ' + this.files.length + ' files selected' : 
                                'Choose folder';
                        });
                    </script>
                    <div class="modal-footer">
                        <button type="button" class="btn register-btn" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn landing-btn">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="folderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Create New Folder</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <form action="{{ url_for('file_manager.upload', path=current_path) }}" method="POST">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="text-light">Folder Name:</label>
                            <input type="text" class="form-control" id="folder_name" name="folder_name"
                                style="background: #1a202c; border: 2px solid #4a5568; color: white;" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn register-btn" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn landing-btn">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Manage Shares Modal -->
    <div class="modal fade" id="manageSharesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Manage Shared Items</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-dark" id="sharesTable">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Type</th>
                                    <th>Created</th>
                                    <th>Expires</th>
                                    <th>Link</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for share in shared_links %}
                                <tr>
                                    <td>{{ share.file.name if share.file else share.folder.name }}</td>
                                    <td>{{ 'File' if share.file else 'Folder' }}</td>
                                    <td>{{ share.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ share.expires_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <div class="input-group">
                                            <input type="text" class="form-control form-control-sm" 
                                                value="{{ url_for('sharing.view_shared', token=share.token, _external=True) }}" 
                                                readonly
                                                style="background: #1a202c; color: white; border-color: #4a5568;">
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary" 
                                                    onclick="copyShareLink(this)"
                                                    data-link="{{ url_for('sharing.view_shared', token=share.token, _external=True) }}">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-warning" 
                                                onclick="extendShare('{{ share.token }}')"
                                                title="Extend expiration">
                                                <i class="fas fa-clock"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" 
                                                onclick="deleteShare('{{ share.token }}')"
                                                title="Delete share">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extend Share Modal -->
    <div class="modal fade" id="extendShareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Extend Share Duration</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="text-light">New expiration:</label>
                        <select class="form-control" id="newExpiration" style="background: #1a202c; color: white; border-color: #4a5568;">
                            <option value="1">1 day</option>
                            <option value="7" selected>7 days</option>
                            <option value="30">30 days</option>
                            <option value="365">1 year</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn register-btn" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn landing-btn" onclick="confirmExtendShare()">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Modal -->
    <div class="modal fade" id="copyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Copy Items</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="text-light">Destination Path:</label>
                        <select class="form-control" id="copyDestination" style="background: #1a202c; color: white; border-color: #4a5568;">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn register-btn" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn landing-btn" onclick="confirmCopy()">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Move Modal -->
    <div class="modal fade" id="moveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Move Items</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="text-light">Destination Path:</label>
                        <select class="form-control" id="moveDestination" style="background: #1a202c; color: white; border-color: #4a5568;">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn register-btn" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn landing-btn" onclick="confirmMove()">Move</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Search Modal -->
    <div class="modal fade" id="globalSearchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Search All Files</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <div class="input-group">
                            <input type="text" id="globalSearchInput" class="form-control"
                                placeholder="Enter search term..."
                                style="background: #1a202c; border: 2px solid #4a5568; color: white;">
                            <div class="input-group-append">
                                <button class="btn landing-btn" onclick="performGlobalSearch()">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="globalSearchResults" class="mt-4">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover" style="background: #1a202c; border-radius: 10px;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="globalSearchResultsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" data-backdrop="static" data-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-light mb-3" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <h5 class="text-light mb-3">Preparing Download</h5>
                    <p class="text-light mt-3 mb-0">Please wait while we prepare your files...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function openGlobalSearch() {
        $('#globalSearchModal').modal('show');
    }

    function performGlobalSearch() {
        const searchTerm = document.getElementById('globalSearchInput').value;
        if (!searchTerm) return;

        fetch(`/search?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tbody = document.getElementById('globalSearchResultsBody');
                    tbody.innerHTML = '';

                    data.results.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                ${item.is_file ? '<i class="fas fa-file text-primary"></i>' : '<i class="fas fa-folder text-warning"></i>'}
                                <a href="${item.is_file ? `/download/${item.path}` : `/browse/${item.path}`}" class="text-light ml-2">
                                    ${item.name}
                                </a>
                            </td>
                            <td>${item.is_file ? 'File' : 'Folder'}</td>
                            <td>${item.size || '-'}</td>
                            <td>${new Date(item.created_at).toLocaleString()}</td>
                            <td>
                                <div class="btn-group">
                                    ${item.is_file ? `
                                        <a href="/download/${item.path}" class="btn btn-sm landing-btn" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    ` : ''}
                                    <button class="btn btn-sm landing-btn" onclick="shareItem('${item.id}', '${item.path}', ${item.is_file})">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
    }

    // Add event listener for Enter key in search input
    document.getElementById('globalSearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performGlobalSearch();
        }
    });

        document.getElementById('fileSearch').addEventListener('keyup', function () {
            const searchInput = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('table tbody tr');

            tableRows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const type = row.cells[2].textContent.toLowerCase();

                if (name.includes(searchInput) || type.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        function deleteItem(path, isFile) {
            if (confirm('Are you sure you want to delete this ' + (isFile ? 'file' : 'folder') + '?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `${deleteItemUrl}${path}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        const deleteItemUrl = "{{ url_for('file_manager.delete_item', path='') }}";

        document.querySelectorAll('input[name="uploadType"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const fileSection = document.getElementById('fileUploadSection');
                const folderSection = document.getElementById('folderUploadSection');

                if (this.value === 'files') {
                    fileSection.classList.remove('d-none');
                    folderSection.classList.add('d-none');
                } else {
                    fileSection.classList.add('d-none');
                    folderSection.classList.remove('d-none');
                }
            });
        });

        let currentItemPath = '';
        let currentItemType = '';

        function shareItem(id, path, isFile) {
            if (!id || id === 'null' || id === 'undefined' || id === 'None') {
                alert('Invalid item ID. Please try refreshing the page.');
                return;
            }
            
            currentItems = [{
                id: id,
                path: path,
                type: isFile ? 'file' : 'folder'
            }];
            
            // Show share modal with selected items
            $('#shareModal').modal('show');
            
            // Update modal title
            $('#shareModal .modal-title').text(`Share ${isFile ? 'File' : 'Folder'}`);
            
            // Hide any previously shown share links
            $('#shareLinkContainer').hide();
            $('#shareLinksContainer').remove();
            
            // Add container for share links
            const shareLinksContainer = $('<div id="shareLinksContainer" class="mt-3" style="display: none;"></div>');
            $('#shareLinkContainer').after(shareLinksContainer);
        }

        function getSelectedItems() {
            const selectedItems = document.querySelectorAll('.item-checkbox:checked');
            const items = Array.from(selectedItems).map(checkbox => {
                const id = checkbox.getAttribute('data-id');
                const path = checkbox.getAttribute('data-path');
                const type = checkbox.getAttribute('data-type');
                
                // Log the item details for debugging
                console.log('Selected item:', { id, path, type });
                
                if (!path) {
                    console.warn('Item missing path:', { id, type });
                    return null;
                }
                
                if (!id || id === 'null' || id === 'undefined' || id === 'None') {
                    console.warn('Invalid ID for item:', { id, path, type });
                    return null;
                }
                
                return {
                    id: id,
                    path: path,
                    type: type
                };
            }).filter(item => item !== null); // Remove any invalid items
            
            console.log('All selected items:', items); // Debug log
            return items;
        }

        function generateShareLink() {
            const expiresIn = $('#expiresIn').val();
            const shareLinksContainer = $('#shareLinksContainer');
            
            // Clear previous links
            shareLinksContainer.empty();
            shareLinksContainer.append('<label class="text-light">Share Link:</label>');
            
            // Create a list to hold the links
            const linksList = $('<div class="list-group" style="background: #1a202c; border-color: #4a5568;"></div>');
            shareLinksContainer.append(linksList);
            
            // Show loading state
            shareLinksContainer.show();
            linksList.append('<div class="text-light p-2">Generating share link...</div>');

            // Get selected items
            const items = currentItems || getSelectedItems();
            if (items.length === 0) {
                linksList.empty();
                linksList.append('<div class="text-danger p-2">No valid items selected</div>');
                return;
            }
            
            // First create the bulk share (virtual folder) if multiple items
            const createShare = items.length > 1 
                ? $.ajax({
                    url: "{{ url_for('sharing.create_bulk_share') }}",
                    method: 'POST',
                    data: { expires_in: expiresIn }
                })
                : Promise.resolve({ status: 'success', bulk_share_id: null });

            createShare.then(function(response) {
                if (response.status === 'success') {
                    const bulkShareId = response.bulk_share_id;
                    let processedCount = 0;
                    const totalItems = items.length;
                    
                    const processNextItem = (index) => {
                        if (index >= totalItems) {
                            if (bulkShareId) {
                                // Show the main share link for bulk share
                                linksList.empty();
                                linksList.append(`
                                    <div class="list-group-item" style="background: #2d3748; border-color: #4a5568;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-folder mr-2"></i>
                                                Shared Folder (${totalItems} items)
                                            </div>
                                            <div class="input-group" style="max-width: 350px;">
                                                <input type="text" class="form-control form-control-sm" 
                                                    value="${response.share_link}" 
                                                    readonly
                                                    style="background: #1a202c; color: white; border-color: #4a5568;">
                                                <div class="input-group-append">
                                                    <button class="btn btn-sm btn-primary" 
                                                        onclick="copyShareLink(this)"
                                                        data-link="${response.share_link}">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `);
                            }
                            return;
                        }
                        
                        const item = items[index];
                        if (!item.id || item.id === 'null' || item.id === 'undefined' || item.id === 'None') {
                            console.error('Invalid item ID:', item);
                            processNextItem(index + 1);
                            return;
                        }
                        
                        let shareUrl = item.type === 'file' 
                            ? "{{ url_for('sharing.share_file', file_id=0) }}".replace('0', item.id)
                            : "{{ url_for('sharing.share_folder', folder_id=0) }}".replace('0', item.id);
                        
                        $.ajax({
                            url: shareUrl,
                            method: 'POST',
                            data: { 
                                expires_in: expiresIn,
                                bulk_share_id: bulkShareId
                            },
                            success: function(response) {
                                if (response.status === 'error') {
                                    console.error('Error sharing item:', response.message);
                                    linksList.append(`
                                        <div class="text-danger p-2">
                                            Error sharing ${item.type}: ${response.message}
                                        </div>
                                    `);
                                } else {
                                    processedCount++;
                                    if (!bulkShareId) {
                                        // Show individual share link
                                        linksList.empty();
                                        linksList.append(`
                                            <div class="list-group-item" style="background: #2d3748; border-color: #4a5568;">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <i class="fas fa-${item.type === 'file' ? 'file' : 'folder'} mr-2"></i>
                                                        ${item.path.split('/').pop()}
                                                    </div>
                                                    <div class="input-group" style="max-width: 350px;">
                                                        <input type="text" class="form-control form-control-sm" 
                                                            value="${response.share_link}" 
                                                            readonly
                                                            style="background: #1a202c; color: white; border-color: #4a5568;">
                                                        <div class="input-group-append">
                                                            <button class="btn btn-sm btn-primary" 
                                                                onclick="copyShareLink(this)"
                                                                data-link="${response.share_link}">
                                                                <i class="fas fa-copy"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `);
                                    } else {
                                        linksList.empty();
                                        linksList.append(`
                                            <div class="text-light p-2">
                                                Processing items... (${processedCount}/${totalItems})
                                            </div>
                                        `);
                                    }
                                }
                                processNextItem(index + 1);
                            },
                            error: function(xhr, status, error) {
                                console.error('Error sharing item:', item, error);
                                let errorMessage = 'Unknown error occurred';
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    errorMessage = response.message || errorMessage;
                                } catch (e) {
                                    // Use default error message
                                }
                                linksList.append(`
                                    <div class="text-danger p-2">
                                        Error sharing ${item.type}: ${errorMessage}
                                    </div>
                                `);
                                processNextItem(index + 1);
                            }
                        });
                    };
                    
                    // Start processing items
                    processNextItem(0);
                } else {
                    linksList.empty();
                    linksList.append('<div class="text-danger p-2">Error creating share</div>');
                }
            }).catch(function(error) {
                console.error('Error creating bulk share:', error);
                linksList.empty();
                linksList.append('<div class="text-danger p-2">Error creating share</div>');
            });
        }

        function copyShareLink(button) {
            const link = button.getAttribute('data-link');
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        function extendShare(token) {
            currentShareToken = token;
            $('#manageSharesModal').modal('hide');
            $('#extendShareModal').modal('show');
        }

        function confirmExtendShare() {
            const days = $('#newExpiration').val();
            
            $.ajax({
                url: "{{ url_for('sharing.extend_share', token='') }}" + currentShareToken,
                method: 'POST',
                data: { expires_in: days },
                success: function(response) {
                    if (response.status === 'success') {
                        location.reload();
                    }
                },
                error: function() {
                    alert('Error extending share');
                }
            });
        }

        function deleteShare(token) {
            if (confirm('Are you sure you want to delete this share link?')) {
                $.ajax({
                    url: "{{ url_for('sharing.delete_share', token='') }}" + token,
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            location.reload();
                        }
                    },
                    error: function() {
                        alert('Error deleting share');
                    }
                });
            }
        }

        $('#extendShareModal').on('hidden.bs.modal', function () {
            $('#manageSharesModal').modal('show');
        });

        // Bulk operations related functions
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkOperationsToolbar();
        });

        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkOperationsToolbar);
        });

        function updateBulkOperationsToolbar() {
            const selectedItems = document.querySelectorAll('.item-checkbox:checked');
            const toolbar = document.getElementById('bulkOperationsToolbar');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedItems.length > 0) {
                toolbar.style.display = 'block';
                selectedCount.textContent = selectedItems.length;
            } else {
                toolbar.style.display = 'none';
            }
        }

        function bulkDownload() {
            const items = getSelectedItems();
            
            if (items.length === 0) {
                alert('Please select at least one item to download');
                return;
            }

            // Show loading modal
            $('#loadingModal').modal('show');

            // Send request to create zip file
            fetch("{{ url_for('file_manager.bulk_download') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ items: items })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                // Create a temporary link to download the file
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bulk_download_${new Date().toISOString().slice(0,19).replace(/[-:]/g, '')}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error preparing download. Please try again.');
            })
            .finally(() => {
                // Hide loading modal
                $('#loadingModal').modal('hide');
            });
        }

        function bulkCopy() {
            const items = getSelectedItems();
            if (items.length === 0) return;
            
            // Show copy modal with selected items
            $('#copyModal').modal('show');
            currentItems = items;
        }

        function bulkMove() {
            const items = getSelectedItems();
            if (items.length === 0) return;
            
            // Show move modal with selected items
            $('#moveModal').modal('show');
            currentItems = items;
        }

        function bulkShare() {
            const items = getSelectedItems();
            if (items.length === 0) {
                alert('Please select at least one item to share');
                return;
            }
            
            // Show share modal with selected items
            $('#shareModal').modal('show');
            currentItems = items;
            
            // Update modal title to reflect bulk operation
            $('#shareModal .modal-title').text(`Share ${items.length} Items`);
            
            // Hide any previously shown share links
            $('#shareLinkContainer').hide();
            $('#shareLinksContainer').remove();
            
            // Add container for multiple share links
            const shareLinksContainer = $('<div id="shareLinksContainer" class="mt-3" style="display: none;"></div>');
            $('#shareLinkContainer').after(shareLinksContainer);
        }

        function bulkDelete() {
            const items = getSelectedItems();
            if (items.length === 0) return;
            
            if (confirm(`Are you sure you want to delete ${items.length} item(s)?`)) {
                items.forEach(item => {
                    $.ajax({
                        url: deleteItemUrl + item.path,
                        method: 'POST',
                        success: function(response) {
                            if (response.status === 'success') {
                                location.reload();
                            }
                        },
                        error: function() {
                            alert('Error deleting items');
                        }
                    });
                });
            }
        }

        function copyItem(id, path, isFile) {
            $('#copyModal').modal('show');
            currentItems = [{
                id: id,
                path: path,
                type: isFile ? 'file' : 'folder'
            }];
        }

        function moveItem(id, path, isFile) {
            $('#moveModal').modal('show');
            currentItems = [{
                id: id,
                path: path,
                type: isFile ? 'file' : 'folder'
            }];
        }

        let currentItems = [];

        $('#copyModal').on('show.bs.modal', function () {
            loadDestinations('copyDestination');
        });

        $('#moveModal').on('show.bs.modal', function () {
            loadDestinations('moveDestination');
        });

        function loadDestinations(elementId) {
            $.ajax({
                url: "{{ url_for('file_manager.get_folders') }}",
                method: 'GET',
                success: function(response) {
                    const select = document.getElementById(elementId);
                    select.innerHTML = '<option value="/">Root</option>';
                    
                    response.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.path;
                        option.textContent = folder.path;
                        select.appendChild(option);
                    });
                },
                error: function() {
                    alert('Error loading destinations');
                }
            });
        }

        function confirmCopy() {
            const destination = document.getElementById('copyDestination').value;
            if (!destination) {
                alert('Please select a destination');
                return;
            }

            currentItems.forEach(item => {
                $.ajax({
                    url: "{{ url_for('file_manager.copy_item') }}",
                    method: 'POST',
                    data: {
                        source_path: item.path,
                        destination_path: destination,
                        is_file: item.type === 'file'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            location.reload();
                        }
                    },
                    error: function() {
                        alert('Error copying items');
                    }
                });
            });
            
            $('#copyModal').modal('hide');
        }

        function confirmMove() {
            const destination = document.getElementById('moveDestination').value;
            if (!destination) {
                alert('Please select a destination');
                return;
            }

            currentItems.forEach(item => {
                $.ajax({
                    url: "{{ url_for('file_manager.move_item') }}",
                    method: 'POST',
                    data: {
                        source_path: item.path,
                        destination_path: destination,
                        is_file: item.type === 'file'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            location.reload();
                        }
                    },
                    error: function() {
                        alert('Error moving items');
                    }
                });
            });
            
            $('#moveModal').modal('hide');
        }
    </script>
</body>

</html>