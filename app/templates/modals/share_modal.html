<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #2d3748;">
            <div class="modal-header">
                <h5 class="modal-title text-light">Share Item</h5>
                <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="text-light">Link expires in:</label>
                    <select class="form-control" id="expiresIn" style="background: #1a202c; color: white; border-color: #4a5568;">
                        <option value="1">1 day</option>
                        <option value="7" selected>7 days</option>
                        <option value="30">30 days</option>
                        <option value="365">1 year</option>
                    </select>
                </div>
                <div class="form-group mt-3" id="shareLinkContainer" style="display: none;">
                    <label class="text-light">Share Link:</label>
                    <div class="input-group">
                        <input type="text" id="shareLink" class="form-control" readonly
                            style="background: #1a202c; color: white; border-color: #4a5568;">
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="copyShareLink()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn register-btn" data-dismiss="modal">Close</button>
                <button type="button" class="btn landing-btn" onclick="generateShareLink()">Generate Link</button>
            </div>
        </div>
    </div>
</div>

<script>
    function shareItem(id, path, isFile) {
        if (!id || id === 'null' || id === 'undefined' || id === 'None') {
            alert('Invalid item ID. Please try refreshing the page.');
            return;
        }
        
        currentItems = [{
            id: id,
            path: path,
            type: isFile ? 'file' : 'folder'
        }];
        
        // Show share modal with selected items
        $('#shareModal').modal('show');
        
        // Update modal title
        $('#shareModal .modal-title').text(`Share ${isFile ? 'File' : 'Folder'}`);
        
        // Hide any previously shown share links
        $('#shareLinkContainer').hide();
        $('#shareLinksContainer').remove();
        
        // Add container for share links
        const shareLinksContainer = $('<div id="shareLinksContainer" class="mt-3" style="display: none;"></div>');
        $('#shareLinkContainer').after(shareLinksContainer);
    }

    function generateShareLink() {
        const expiresIn = $('#expiresIn').val();
        const shareLinksContainer = $('#shareLinksContainer');
        
        // Clear previous links
        shareLinksContainer.empty();
        shareLinksContainer.append('<label class="text-light">Share Link:</label>');
        
        // Create a list to hold the links
        const linksList = $('<div class="list-group" style="background: #1a202c; border-color: #4a5568;"></div>');
        shareLinksContainer.append(linksList);
        
        // Show loading state
        shareLinksContainer.show();
        linksList.append('<div class="text-light p-2">Generating share link...</div>');

        // Get selected items
        const items = currentItems || getSelectedItems();
        if (items.length === 0) {
            linksList.empty();
            linksList.append('<div class="text-danger p-2">No valid items selected</div>');
            return;
        }
        
        // First create the bulk share (virtual folder) if multiple items
        const createShare = items.length > 1 
            ? $.ajax({
                url: "{{ url_for('sharing.create_bulk_share') }}",
                method: 'POST',
                data: { expires_in: expiresIn }
            })
            : Promise.resolve({ status: 'success', bulk_share_id: null });

        createShare.then(function(response) {
            if (response.status === 'success') {
                const bulkShareId = response.bulk_share_id;
                let processedCount = 0;
                const totalItems = items.length;
                
                const processNextItem = (index) => {
                    if (index >= totalItems) {
                        if (bulkShareId) {
                            // Show the main share link for bulk share
                            linksList.empty();
                            linksList.append(`
                                <div class="list-group-item" style="background: #2d3748; border-color: #4a5568;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-folder mr-2"></i>
                                            Shared Folder (${totalItems} items)
                                        </div>
                                        <div class="input-group" style="max-width: 350px;">
                                            <input type="text" class="form-control form-control-sm" 
                                                value="${response.share_link}" 
                                                readonly
                                                style="background: #1a202c; color: white; border-color: #4a5568;">
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary" 
                                                    onclick="copyShareLink(this)"
                                                    data-link="${response.share_link}">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `);
                        }
                        return;
                    }
                    
                    const item = items[index];
                    if (!item.id || item.id === 'null' || item.id === 'undefined' || item.id === 'None') {
                        console.error('Invalid item ID:', item);
                        processNextItem(index + 1);
                        return;
                    }
                    
                    let shareUrl = item.type === 'file' 
                        ? "{{ url_for('sharing.share_file', file_id=0) }}".replace('0', item.id)
                        : "{{ url_for('sharing.share_folder', folder_id=0) }}".replace('0', item.id);
                    
                    $.ajax({
                        url: shareUrl,
                        method: 'POST',
                        data: { 
                            expires_in: expiresIn,
                            bulk_share_id: bulkShareId
                        },
                        success: function(response) {
                            if (response.status === 'error') {
                                console.error('Error sharing item:', response.message);
                                linksList.append(`
                                    <div class="text-danger p-2">
                                        Error sharing ${item.type}: ${response.message}
                                    </div>
                                `);
                            } else {
                                processedCount++;
                                if (!bulkShareId) {
                                    // Show individual share link
                                    linksList.empty();
                                    linksList.append(`
                                        <div class="list-group-item" style="background: #2d3748; border-color: #4a5568;">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-${item.type === 'file' ? 'file' : 'folder'} mr-2"></i>
                                                    ${item.path.split('/').pop()}
                                                </div>
                                                <div class="input-group" style="max-width: 350px;">
                                                    <input type="text" class="form-control form-control-sm" 
                                                        value="${response.share_link}" 
                                                        readonly
                                                        style="background: #1a202c; color: white; border-color: #4a5568;">
                                                    <div class="input-group-append">
                                                        <button class="btn btn-sm btn-primary" 
                                                            onclick="copyShareLink(this)"
                                                            data-link="${response.share_link}">
                                                            <i class="fas fa-copy"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `);
                                } else {
                                    linksList.empty();
                                    linksList.append(`
                                        <div class="text-light p-2">
                                            Processing items... (${processedCount}/${totalItems})
                                        </div>
                                    `);
                                }
                            }
                            processNextItem(index + 1);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error sharing item:', item, error);
                            let errorMessage = 'Unknown error occurred';
                            try {
                                const response = JSON.parse(xhr.responseText);
                                errorMessage = response.message || errorMessage;
                            } catch (e) {
                                // Use default error message
                            }
                            linksList.append(`
                                <div class="text-danger p-2">
                                    Error sharing ${item.type}: ${errorMessage}
                                </div>
                            `);
                            processNextItem(index + 1);
                        }
                    });
                };
                
                // Start processing items
                processNextItem(0);
            } else {
                linksList.empty();
                linksList.append('<div class="text-danger p-2">Error creating share</div>');
            }
        }).catch(function(error) {
            console.error('Error creating bulk share:', error);
            linksList.empty();
            linksList.append('<div class="text-danger p-2">Error creating share</div>');
        });
    }

    function copyShareLink(button) {
        const link = button.getAttribute('data-link');
        navigator.clipboard.writeText(link).then(() => {
            alert('Link copied to clipboard!');
        });
    }
    
</script>