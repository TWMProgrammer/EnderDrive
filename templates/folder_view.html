<!DOCTYPE html>
<html lang="en">
<head>
    <title>File Browser - EnderDrive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/darkly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body style="background: linear-gradient(135deg, #1a1c2c 0%, #2d3748 100%); min-height: 100vh;">
    <!-- Navbar -->
    <nav class="navbar" style="background: #2d3748; padding: 1rem 2rem; width: 100%;">
        <div class="d-flex align-items-center">
            <span class="navbar-text mr-3 text-light">Welcome, {{ username }}</span>
            {% if is_admin %}
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-info ml-2 landing-btn">
                <i class="fas fa-user-shield"></i> Admin Dashboard
            </a>
            {% endif %}
        </div>
        <div class="d-flex">
            <button class="btn landing-btn ml-2" data-toggle="modal" data-target="#uploadModal">
                <i class="fas fa-upload"></i> Upload Files
            </button>
            <button class="btn landing-btn ml-2" data-toggle="modal" data-target="#folderModal">
                <i class="fas fa-folder-plus"></i> New Folder
            </button>
            <a href="{{ url_for('logout') }}" class="btn landing-btn register-btn ml-2">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb" style="background: #1a202c; border-radius: 10px;">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('browse', path='') }}" class="text-light">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                {% for crumb in breadcrumbs %}
                <li class="breadcrumb-item">
                    <a href="{{ url_for('browse', path=crumb.path) }}" class="text-light">{{ crumb.name }}</a>
                </li>
                {% endfor %}
            </ol>
        </nav>

        <div class="landing-box" style="padding: 2rem; margin-top: 1rem;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0 text-light">Files and Folders</h4>
                <div class="search-container" style="width: 400px;">
                    <div class="input-group">
                        <input type="text" id="fileSearch" class="form-control" 
                               placeholder="Search files and folders..." 
                               style="background: #1a202c; border: 2px solid #4a5568; color: white;">
                        <div class="input-group-append">
                            <span class="input-group-text" style="background: #1a202c; border-color: #4a5568;">
                                <i class="fas fa-search text-light"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-dark table-hover" style="background: #1a202c; border-radius: 10px;">
                    <thead class="thead-light">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if current_path %}
                        <tr>
                            <td colspan="5">
                                <a href="{{ url_for('browse', path=current_path.rsplit('/', 1)[0] if '/' in current_path else '') }}" 
                                   class="text-light">
                                    <i class="fas fa-level-up-alt"></i> ..
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                        
                        {% for item in items %}
                        <tr style="border-color: #2d3748;">
                            <td>
                                {% if item.is_file %}
                                    <i class="fas fa-file text-primary"></i>
                                    <a href="{{ url_for('download_file', path=item.path) }}" class="text-light ml-2">
                                        {{ item.name }}
                                    </a>
                                {% else %}
                                    <i class="fas fa-folder text-warning"></i>
                                    <a href="{{ url_for('browse', path=item.path) }}" class="text-light ml-2">
                                        {{ item.name }}
                                    </a>
                                {% endif %}
                            </td>
                            <td>{{ 'File' if item.is_file else 'Folder' }}</td>
                            <td>{{ item.size if item.is_file else '-' }}</td>
                            <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <div class="btn-group">
                                    {% if item.is_file %}
                                    <a href="{{ url_for('download_file', path=item.path) }}" 
                                       class="btn btn-sm landing-btn">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    {% endif %}
                                    <button class="btn btn-sm landing-btn register-btn" 
                                            onclick="deleteItem('{{ item.path }}', {{ 'true' if item.is_file else 'false' }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Upload Files</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <form action="{{ url_for('upload', path=current_path) }}" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="text-light">Upload Type:</label>
                            <div class="btn-group btn-group-toggle w-100 mb-3" data-toggle="buttons">
                                <label class="btn btn-outline-primary active">
                                    <input type="radio" name="uploadType" value="files" checked> Files
                                </label>
                                <label class="btn btn-outline-primary">
                                    <input type="radio" name="uploadType" value="folder"> Folder
                                </label>
                            </div>
                        </div>
                        <div class="form-group" id="fileUploadSection">
                            <label class="text-light">Select Files:</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="file" name="file" multiple>
                                <label class="custom-file-label" for="file" style="background: #1a202c; color: white; border-color: #4a5568;">
                                    Choose files
                                </label>
                            </div>
                        </div>
                        <div class="form-group d-none" id="folderUploadSection">
                            <label class="text-light">Select Folder:</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="folder" name="folder[]" webkitdirectory directory multiple>
                                <label class="custom-file-label" for="folder" style="background: #1a202c; color: white; border-color: #4a5568;">
                                    Choose folder
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn register-btn" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn landing-btn">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="folderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #2d3748;">
                <div class="modal-header">
                    <h5 class="modal-title text-light">Create New Folder</h5>
                    <button type="button" class="close text-light" data-dismiss="modal">&times;</button>
                </div>
                <form action="{{ url_for('upload', path=current_path) }}" method="POST">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="text-light">Folder Name:</label>
                            <input type="text" class="form-control" id="folder_name" name="folder_name" 
                                   style="background: #1a202c; border: 2px solid #4a5568; color: white;" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn register-btn" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn landing-btn">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('fileSearch').addEventListener('keyup', function() {
            const searchInput = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('table tbody tr');
            
            tableRows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const type = row.cells[1].textContent.toLowerCase();
                
                if (name.includes(searchInput) || type.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        function deleteItem(path, isFile) {
            if (confirm('Are you sure you want to delete this ' + (isFile ? 'file' : 'folder') + '?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `${deleteItemUrl}${path}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        const deleteItemUrl = "{{ url_for('delete_item', path='') }}";

        document.querySelectorAll('input[name="uploadType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const fileSection = document.getElementById('fileUploadSection');
                const folderSection = document.getElementById('folderUploadSection');
                
                if (this.value === 'files') {
                    fileSection.classList.remove('d-none');
                    folderSection.classList.add('d-none');
                } else {
                    fileSection.classList.add('d-none');
                    folderSection.classList.remove('d-none');
                }
            });
        });
    </script>
</body>
</html>